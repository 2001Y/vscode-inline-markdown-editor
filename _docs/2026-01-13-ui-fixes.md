# 2026-01-13 UI/Protocol Fixes

## 目的
- ブロックハンドルのレイアウトを CSS だけで安定化（hover 時に消える/はみ出し問題の整理）。
- コードブロックのラベルを `::before` ではなく `.block-label` DOM に統一。
- テーブルコンテキストメニューの非表示/操作不全を解消。
- Webview の `editorCommand` をプロトコル外として扱い、`PROTOCOL_VERSION_MISMATCH` を抑止。

## 実装方針
- `block-handle-host` を `display:flex` にし、ハンドルをフロー内に置く（絶対配置・負の left を廃止）。
- リスト項目は `display:list-item` を維持し、ハンドルだけ inline-flex で差し込む。
- コードブロック/プレーンテキスト/フロントマターのラベルは `.block-label` に統一（data-code-label 廃止）。
- テーブルメニューは `block-menu` へ統合し、メニュー表示中は hover 判定で `hideControls` しない。
- Webview SyncClient は `editorCommand` を無視し、プロトコル外メッセージでエラーを出さない。

## 影響範囲
- `packages/webview/src/styles.css`（ハンドルレイアウト / block-label / table-context-menu 旧CSS削除）
- `packages/webview/src/editor/disableKeyboardShortcuts.ts`（コードブロック label DOM）
- `packages/webview/src/editor/plainTextBlockExtension.ts`
- `packages/webview/src/editor/frontmatterBlockExtension.ts`
- `packages/webview/src/editor/rawBlockExtension.ts`
- `packages/webview/src/editor/tableControlsExtension.ts`
- `packages/webview/src/protocol/client.ts`
- `packages/webview/src/main.ts`

## 未解決
- ネストページ作成の ack/response が届かない件は引き続き調査（Output ログ必須）。

## 追加対応 (2026-01-13)
- リスト drag 時に dropcursor が no-op 判定で消える問題に対し、list drag では **simulateDropNoop** を優先して判定。
- list drag の manual drop も同ロジックで no-op を再判定（挿入線の誤非表示を抑制）。
- 空ブロック (placeholder) クリック時に選択が飛ぶため、`.block-handle-host.is-empty` クリック時は
  `posAtCoords` で selection を補正しログ化。
- block-menu は同一ハンドルの2回目クリックで閉じるようにトグル化。

## 追加対応 (2026-01-13 追補)
- list drag の no-op 判定は **source listItem と target listItem** の一致で判定（挿入線の常時非表示を抑制）。
- listItem の handle デコレーション後も子リストへ降りるようにして、ネスト listItem にもハンドルを表示。
- placeholder フォーカスは `posAtCoords` ではなく **host DOM の pos** を優先。
- list drag の manual drop は **simulateDropNoop が true の場合は確実に noop** 扱いに変更（空 li 生成の抑制）。
- list dropcursor は **indent 変化が 0 でも text start に合わせて描画**。
- ブロック drag の indent 調整を追加（±1 step / 最大 10）、dropcursor も同ロジックで移動。
- drag end 時は dropcursor を強制的に隠すように調整。

## 追加対応 (2026-01-13)
- drop target 解決で **block-handle-host のみ** を対象にし、DOMルート等の誤ヒットで `pos=0` が返る経路を削除。
- ブロック drag の dropcursor は **target インデントとの差分**で左位置を補正し、仮想インデントでも可視化されるように調整。

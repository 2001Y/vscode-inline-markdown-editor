# Table DnD 再調査メモ（o3 + DeepWiki）(2026-01-11)

## 背景
- テーブル行/列DnDが発火せず、ログも出ない。
- 既存は pointer-based 実装だが、`cellPos` 基準とイベント取得に不安があった。

## DeepWiki (prosemirror-tables) 要点
- `TableMap.findCell` は **table.start 基準のセル開始位置**を受け取る。
  - 例: `map.findCell(cellStart - table.start)`
- `cellAround($pos)` は **セル開始位置(=pos before cell)** を返す。
- `moveTableRow / moveTableColumn` の `pos` は「対象テーブル内であればどこでも可」だが、
  **確実なのはセル開始位置($cell.pos) を渡す**。

## o3 回答要点
- pointer-based DnD は **handle要素で pointerdown を確実に拾う**ことが最重要。
  - `pointerdown` → `setPointerCapture` → `pointermove/up` を継続取得
  - handle DOM はドラッグ中に remove しない（pointer capture が失われる）
  - `touch-action: none` を handle に付与してスクロール介入を防ぐ
- handle が view.dom 外にある場合は **document で pointerdown を拾う**方が堅い。
- drop indicator は **行 or 列のどちらか片方のみ**表示。
  - pointer-basedなら dropcursor は基本発火しないが、併用時は一時的に非表示にするのが安全。

## 実装反映方針
- **cellPos はセル開始位置で統一**（+1 の inside 位置は selection 用のみ）。
- pointerdown を **document capture** に寄せてログ取得を確実化。
- handle に `touch-action: none` を追加。
- エラー/開始/完了に INFO/SUCCESS/ERROR を追加。

